import geoLocationManager from '@ohos.geoLocationManager';
import router from '@ohos.router';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { HarmonyGeo } from '../common/geo';
import { MapServiceFactory } from '../map/MapServiceFactory';
import { MapService, ToiletPoi } from '../map/MapService';
import AppStorage from '../common/AppStorage';
import { ToiletCard } from '../components/ToiletCard';
import { ErrorBanner } from '../components/ErrorBanner';
import { TopBar } from '../widget/TopBar';

const TAG = 'Index';

@Entry
@Component
struct Index {
  @State isLoading: boolean = false;
  @State toilets: ToiletPoi[] = [];
  @State error: string = '';
  @State center: geoLocationManager.Location | null = null;
  @State private travelMode: string = 'walking'; // å‡ºè¡Œæ–¹å¼ï¼šwalking æˆ– cycling
  @State private buttonMoved: boolean = false; // æŒ‰é’®æ˜¯å¦å·²ç§»åŠ¨åˆ°åº•éƒ¨
  @State private showToiletList: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå…¬åŽ•åˆ—è¡¨
  @State private buttonPressed: boolean = false; // æŒ‰é’®ç‚¹å‡»çŠ¶æ€
  @State private buttonScale: number = 1.0; // æŒ‰é’®ç¼©æ”¾æ¯”ä¾‹
  @State private breathingScale: number = 1.0; // å‘¼å¸åŠ¨ç”»ç¼©æ”¾æ¯”ä¾‹
  @State private swipeStartX: number = 0; // æ»‘åŠ¨å¼€å§‹çš„Xåæ ‡
  @State private swipeCurrentX: number = 0; // æ»‘åŠ¨å½“å‰çš„Xåæ ‡
  @State private isSwipeActive: boolean = false; // æ˜¯å¦æ­£åœ¨æ»‘åŠ¨
  @State private swipeOffset: number = 0; // æ»‘åŠ¨åç§»é‡
  @StorageLink('searchDistance') searchDistance: number = 500; // æœç´¢è·ç¦»ï¼Œé»˜è®¤500ç±³
  private geoService: HarmonyGeo | null = null;
  private mapService: MapService | null = null;
  private context: common.UIAbilityContext | null = null;

  async aboutToAppear() {
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      if (this.context) {
        this.geoService = new HarmonyGeo(this.context);
        this.mapService = await MapServiceFactory.createMapService();
      }
      
      // å¯åŠ¨å‘¼å¸åŠ¨ç”»
      this.startBreathingAnimation();
    } catch (err) {
      const error = err as BusinessError;
      console.error(TAG, `Failed to get context, error: ${JSON.stringify(error)}`);
      this.error = `Failed to get context: ${error.message}`;
    }
  }

  // å‘¼å¸åŠ¨ç”»
  private startBreathingAnimation() {
    const breathingLoop = () => {
      if (!this.buttonMoved) {
        animateTo({
          duration: 2000,
          curve: Curve.EaseInOut,
          iterations: -1,
          playMode: PlayMode.Alternate
        }, () => {
          this.breathingScale = 1.05;
        });
      }
    };
    breathingLoop();
  }

  // ç‚¹å‡»åŠ¨ç”»æ•ˆæžœ
  private handleButtonPress() {
    // ç‚¹å‡»ç¼©æ”¾åŠ¨ç”»
    this.buttonPressed = true;
    animateTo({
      duration: 100,
      curve: Curve.Sharp
    }, () => {
      this.buttonScale = 0.95;
    });
    
    // å¼¹è·³å›žå¼¹åŠ¨ç”»
    setTimeout(() => {
      animateTo({
        duration: 200,
        curve: Curve.EaseOut
      }, () => {
        this.buttonScale = 1.1;
      });
      
      setTimeout(() => {
        animateTo({
          duration: 150,
          curve: Curve.EaseInOut
        }, () => {
          this.buttonScale = 1.0;
          this.buttonPressed = false;
        });
      }, 200);
    }, 100);
  }

  // è®¾ç½®æŒ‰é’®ç‚¹å‡»å¤„ç†
  private handleSettingsClick() {
    console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»');
    router.pushUrl({
      url: 'pages/Settings'
    }).catch((error: Error) => {
      console.error('å¯¼èˆªåˆ°è®¾ç½®é¡µé¢å¤±è´¥:', error.message);
    });
  }

  // æ»‘åŠ¨æ‰‹åŠ¿å¤„ç†æ–¹æ³•
  private handleSwipeStart(x: number) {
    this.swipeStartX = x;
    this.swipeCurrentX = x;
    this.isSwipeActive = true;
    this.swipeOffset = 0;
  }

  private handleSwipeMove(x: number) {
    if (!this.isSwipeActive) return;
    
    this.swipeCurrentX = x;
    this.swipeOffset = x - this.swipeStartX;
    
    // æ·»åŠ å®žæ—¶è§†è§‰åé¦ˆ - è½»å¾®çš„åç§»æ•ˆæžœ
    const maxOffset = 30; // æœ€å¤§åç§»é‡
    const normalizedOffset = Math.max(-maxOffset, Math.min(maxOffset, this.swipeOffset * 0.3));
    
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®žæ—¶çš„è§†è§‰åé¦ˆï¼Œæ¯”å¦‚è½»å¾®çš„ä½ç§»æˆ–é€æ˜Žåº¦å˜åŒ–
  }

  private handleSwipeEnd() {
    if (!this.isSwipeActive) return;
    
    const swipeDistance = Math.abs(this.swipeOffset);
    const minSwipeDistance = 50; // æœ€å°æ»‘åŠ¨è·ç¦»
    
    if (swipeDistance > minSwipeDistance) {
      if (this.swipeOffset > 0) {
        // å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°æ­¥è¡Œ
        this.switchTravelMode('walking');
      } else {
        // å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°éª‘è¡Œ
        this.switchTravelMode('cycling');
      }
    }
    
    // é‡ç½®æ»‘åŠ¨çŠ¶æ€
    this.isSwipeActive = false;
    this.swipeOffset = 0;
    this.swipeStartX = 0;
    this.swipeCurrentX = 0;
  }

  private switchTravelMode(mode: string) {
    if (this.travelMode !== mode) {
      // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æžœæ”¯æŒï¼‰
      // HapticFeedback.impactLight();
      
      animateTo({
        duration: 400,
        curve: Curve.EaseInOut,
        playMode: PlayMode.Normal
      }, () => {
        this.travelMode = mode;
      });
      
      // æ·»åŠ åˆ‡æ¢æˆåŠŸçš„è§†è§‰æç¤º
      setTimeout(() => {
        animateTo({
          duration: 200,
          curve: Curve.EaseOut
        }, () => {
          // å¯ä»¥æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„é«˜äº®æ•ˆæžœ
        });
      }, 100);
    }
  }

  async handleFindToilet() {
    if (this.isLoading || !this.geoService || !this.mapService) {
      return;
    }
    
    // å…ˆæ‰§è¡Œç‚¹å‡»åŠ¨ç”»
    this.handleButtonPress();
    
    // å»¶è¿Ÿæ‰§è¡Œæœç´¢ï¼Œè®©åŠ¨ç”»å…ˆå®Œæˆ
    setTimeout(() => {
      // è§¦å‘æŒ‰é’®å‘ä¸‹ç§»åŠ¨åŠ¨ç”»
      this.buttonMoved = true;
      
      this.performSearch();
    }, 450); // ç­‰å¾…ç‚¹å‡»åŠ¨ç”»å®Œæˆ
  }

  private async performSearch() {
    this.isLoading = true;
    this.error = '';
    this.showToiletList = false;
    this.toilets = [];
    
    try {
      // æ£€æŸ¥æƒé™
      if (!await this.geoService!.checkPermission()) {
        try {
          await this.geoService!.requestPermission();
        } catch (permissionError) {
          this.error = 'Location permission denied. Please enable location access in settings.';
          this.isLoading = false;
          return;
        }
      }
      const location = await this.geoService!.getCurrentLocation();
      this.center = location;
      
      // æ·»åŠ ç§»åŠ¨åŠ¨ç”»çš„å»¶è¿Ÿæ•ˆæžœ
      animateTo({
        duration: 600,
        curve: Curve.EaseInOut
      }, () => {
        // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æœç´¢è·ç¦»æœç´¢å…¬åŽ•
        this.mapService!.searchNearbyToilets(location.longitude, location.latitude, this.searchDistance)
          .then(toilets => {
            this.toilets = toilets;
            this.showToiletList = true;
          });
      });
      
    } catch (err) {
      const error = err as Error;
      console.error(TAG, `Failed to find toilets, error: ${JSON.stringify(error)}`);
      this.error = `Failed to find toilets: ${error.message || 'Unknown error'}`;
    } finally {
      this.isLoading = false;
    }
  }

  build(): void {
    Column() {
      // é¡¶éƒ¨è®¾ç½®æŒ‰é’®åŒºåŸŸ
      Row() {
        Button() {
          Text('âš™ï¸')
            .fontSize(20)
            .fontColor('#666666')
        }
        .width(48)
        .height(48)
        .backgroundColor('#F5F5F5')
        .borderRadius(24)
        .onClick(() => this.handleSettingsClick())
        .shadow({
          radius: 4,
          color: '#00000020',
          offsetX: 0,
          offsetY: 2
        })
        
        Blank()
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16 })
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        if (!this.buttonMoved) {
          // å±…ä¸­æ˜¾ç¤ºçš„åœ†å½¢æ‰¾å±ŽæŒ‰é’®
          Button('æ‰¾å±Ž')
            .width(120)
            .height(120)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#007DFF')
            .borderRadius(60)
            .shadow({
              radius: 25,
              color: '#007DFF',
              offsetX: 0,
              offsetY: 10
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleSwipeStart(event.touches[0].x);
              } else if (event.type === TouchType.Move) {
                this.handleSwipeMove(event.touches[0].x);
              } else if (event.type === TouchType.Up) {
                this.handleSwipeEnd();
              }
            })
            .scale({
              x: this.buttonScale * this.breathingScale,
              y: this.buttonScale * this.breathingScale
            })
            .animation({
              duration: 500,
              curve: Curve.EaseInOut
            })
            .onClick(() => this.handleFindToilet())
        }
        
        // åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
        if (this.isLoading) {
          Column({ space: 16 }) {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#007DFF')
            
            Text('æ­£åœ¨æœç´¢é™„è¿‘çš„å…¬åŽ•...')
              .fontSize(16)
              .fontColor('#666666')
          }
          .margin({ top: 40 })
        }
        
        // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        if (this.error) {
          Column({ space: 12 }) {
            Text('ðŸ˜”')
              .fontSize(32)
            
            Text(this.error)
              .fontSize(14)
              .fontColor('#FF4444')
              .textAlign(TextAlign.Center)
              .maxLines(2)
            
            Button('é‡è¯•')
              .width(80)
              .height(32)
              .fontSize(12)
              .backgroundColor('#007DFF')
              .borderRadius(16)
              .onClick(() => {
                this.error = '';
                this.handleFindToilet();
              })
          }
          .margin({ top: 40 })
          .padding(20)
        }
        
        // å…¬åŽ•åˆ—è¡¨åŒºåŸŸ
        if (this.showToiletList && this.toilets.length > 0) {
          Column() {
            Text(`æ‰¾åˆ° ${this.toilets.length} ä¸ªå…¬åŽ•`)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .margin({ bottom: 16 })
            
            List() {
              ForEach(this.toilets, (toilet: ToiletPoi, index: number) => {
                ListItem() {
                  ToiletCard({
                    toilet: toilet,
                    travelMode: this.travelMode,
                    onNavigate: () => {
                      // å¯¼èˆªåŠŸèƒ½
                      console.log(`Navigate to toilet: ${toilet.name}`);
                    }
                  })
                }
              })
            }
            .width('100%')
            .layoutWeight(1)
            .scrollBar(BarState.Auto)
            .edgeEffect(EdgeEffect.Spring)
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 16 })
          .animation({
            duration: 300,
            curve: Curve.EaseOut
          })
        }
        
        // æ— ç»“æžœæç¤º
        if (this.showToiletList && this.toilets.length === 0 && !this.isLoading) {
          Column({ space: 16 }) {
            Text('ðŸš½')
              .fontSize(48)
              .opacity(0.3)
            
            Text('é™„è¿‘1å…¬é‡Œå†…æ²¡æœ‰æ‰¾åˆ°å…¬åŽ•')
              .fontSize(16)
              .fontColor('#666666')
            
            Text('è¯•è¯•æ‰©å¤§æœç´¢èŒƒå›´æˆ–æ¢ä¸ªä½ç½®')
              .fontSize(14)
              .fontColor('#999999')
            
            Button('é‡æ–°æœç´¢')
              .width(100)
              .height(36)
              .fontSize(14)
              .backgroundColor('#007DFF')
              .borderRadius(18)
              .onClick(() => {
                this.showToiletList = false;
                this.buttonMoved = false;
              })
          }
          .margin({ top: 60 })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(this.buttonMoved ? FlexAlign.Start : FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor('#F8F9FA')
      
      // åº•éƒ¨å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨ï¼ˆæ·¡åŒ–è®¾è®¡ï¼‰
      if (this.buttonMoved) {
        // ç§»åŠ¨åŽçš„æŒ‰é’®æ˜¾ç¤ºåœ¨åº•éƒ¨é€‰æ‹©å™¨ä¸Šæ–¹
        Column({ space: 12 }) {
          Button('æ‰¾å±Ž')
            .width(80)
            .height(80)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#007DFF')
            .borderRadius(40)
            .shadow({
              radius: 15,
              color: '#007DFF',
              offsetX: 0,
              offsetY: 5
            })
            .scale({
              x: this.buttonScale,
              y: this.buttonScale
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => this.handleFindToilet())
          
          // å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨
          Column({ space: 8 }) {
            Text('å‡ºè¡Œæ–¹å¼')
              .fontSize(12)
              .fontColor('#999999')
            
            Row({ space: 20 }) {
              // æ­¥è¡ŒæŒ‰é’®
              Column({ space: 4 }) {
                Text('ðŸš¶')
                  .fontSize(20)
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
                Text('æ­¥è¡Œ')
                  .fontSize(10)
                  .fontColor(this.travelMode === 'walking' ? '#007DFF' : '#CCCCCC')
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
              }
              .width(50)
              .height(50)
              .borderRadius(25)
              .backgroundColor(this.travelMode === 'walking' ? '#F0F8FF' : 'transparent')
              .border({
                width: this.travelMode === 'walking' ? 2 : 1,
                color: this.travelMode === 'walking' ? '#007DFF' : '#E0E0E0'
              })
              .justifyContent(FlexAlign.Center)
              .scale({
                x: this.travelMode === 'walking' ? 1.1 : 1.0,
                y: this.travelMode === 'walking' ? 1.1 : 1.0
              })
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
              .onClick(() => {
                this.travelMode = 'walking';
              })
              
              // éª‘è¡ŒæŒ‰é’®
              Column({ space: 4 }) {
                Text('ðŸš´')
                  .fontSize(20)
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
                Text('éª‘è¡Œ')
                  .fontSize(10)
                  .fontColor(this.travelMode === 'cycling' ? '#007DFF' : '#CCCCCC')
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
              }
              .width(50)
              .height(50)
              .borderRadius(25)
              .backgroundColor(this.travelMode === 'cycling' ? '#F0F8FF' : 'transparent')
              .border({
                width: this.travelMode === 'cycling' ? 2 : 1,
                color: this.travelMode === 'cycling' ? '#007DFF' : '#E0E0E0'
              })
              .justifyContent(FlexAlign.Center)
              .scale({
                x: this.travelMode === 'cycling' ? 1.1 : 1.0,
                y: this.travelMode === 'cycling' ? 1.1 : 1.0
              })
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
              .onClick(() => {
                this.travelMode = 'cycling';
              })
            }
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleSwipeStart(event.touches[0].x);
              } else if (event.type === TouchType.Move) {
                this.handleSwipeMove(event.touches[0].x);
              } else if (event.type === TouchType.Up) {
                this.handleSwipeEnd();
              }
            })
          }
          .onTouch((event: TouchEvent) => {
            if (event.type === TouchType.Down) {
              this.handleSwipeStart(event.touches[0].x);
            } else if (event.type === TouchType.Move) {
              this.handleSwipeMove(event.touches[0].x);
            } else if (event.type === TouchType.Up) {
              this.handleSwipeEnd();
            }
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 20 })
        .backgroundColor('#FAFAFA')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // åŽŸå§‹åº•éƒ¨å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨
        Column({ space: 8 }) {
          Text('å‡ºè¡Œæ–¹å¼')
            .fontSize(12)
            .fontColor('#999999')
          
          Row({ space: 20 }) {
            // æ­¥è¡ŒæŒ‰é’®
            Column({ space: 4 }) {
              Text('ðŸš¶')
                .fontSize(20)
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
              Text('æ­¥è¡Œ')
                .fontSize(10)
                .fontColor(this.travelMode === 'walking' ? '#007DFF' : '#CCCCCC')
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
            }
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor(this.travelMode === 'walking' ? '#F0F8FF' : 'transparent')
            .border({
              width: this.travelMode === 'walking' ? 2 : 1,
              color: this.travelMode === 'walking' ? '#007DFF' : '#E0E0E0'
            })
            .justifyContent(FlexAlign.Center)
            .scale({
              x: this.travelMode === 'walking' ? 1.1 : 1.0,
              y: this.travelMode === 'walking' ? 1.1 : 1.0
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => {
              this.travelMode = 'walking';
            })
            
            // éª‘è¡ŒæŒ‰é’®
            Column({ space: 4 }) {
              Text('ðŸš´')
                .fontSize(20)
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
              Text('éª‘è¡Œ')
                .fontSize(10)
                .fontColor(this.travelMode === 'cycling' ? '#007DFF' : '#CCCCCC')
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
            }
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor(this.travelMode === 'cycling' ? '#F0F8FF' : 'transparent')
            .border({
              width: this.travelMode === 'cycling' ? 2 : 1,
              color: this.travelMode === 'cycling' ? '#007DFF' : '#E0E0E0'
            })
            .justifyContent(FlexAlign.Center)
            .scale({
              x: this.travelMode === 'cycling' ? 1.1 : 1.0,
              y: this.travelMode === 'cycling' ? 1.1 : 1.0
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => {
              this.travelMode = 'cycling';
            })
          }
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 20 })
        .backgroundColor('#FAFAFA')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }
}



