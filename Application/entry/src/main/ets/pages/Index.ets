import geoLocationManager from '@ohos.geoLocationManager';
import router from '@ohos.router';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { HarmonyGeo } from '../common/geo';
import { MapServiceFactory } from '../map/MapServiceFactory';
import { MapService, ToiletPoi } from '../map/MapService';
import MapLauncher from '../map/MapLauncher';
import AppStorage from '../common/AppStorage';
import LocationLogStore, { LocationLog } from '../common/LocationLogStore';
import SearchLogStore, { SearchLog, SearchLogInfo } from '../common/SearchLogStore';
import { ToiletCard, NavigateHandler, NavigateHandlerImpl } from '../components/ToiletCard';
import { ErrorBanner } from '../components/ErrorBanner';

const TAG = 'Index';

@Entry
@Component
struct Index {
  @State isLoading: boolean = false;
  @State toilets: ToiletPoi[] = [];
  @State error: string = '';
  @State center: geoLocationManager.Location | null = null;
  @State private travelMode: string = 'walking'; // å‡ºè¡Œæ–¹å¼ï¼šwalking æˆ– cycling
  @State private buttonMoved: boolean = false; // æŒ‰é’®æ˜¯å¦å·²ç§»åŠ¨åˆ°åº•éƒ¨
  @State private showToiletList: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå…¬å•åˆ—è¡¨
  @State private buttonPressed: boolean = false; // æŒ‰é’®ç‚¹å‡»çŠ¶æ€
  @State private buttonScale: number = 1.0; // æŒ‰é’®ç¼©æ”¾æ¯”ä¾‹
  @State private breathingScale: number = 1.0; // å‘¼å¸åŠ¨ç”»ç¼©æ”¾æ¯”ä¾‹
  @State private swipeStartX: number = 0; // æ»‘åŠ¨å¼€å§‹çš„Xåæ ‡
  @State private swipeCurrentX: number = 0; // æ»‘åŠ¨å½“å‰çš„Xåæ ‡
  @State private isSwipeActive: boolean = false; // æ˜¯å¦æ­£åœ¨æ»‘åŠ¨
  @State private swipeOffset: number = 0; // æ»‘åŠ¨åç§»é‡
  @State private visibleCount: number = 0; // å·²æ˜¾ç¤ºçš„å¡ç‰‡æ•°é‡ï¼ˆç”¨äºé€ä¸ªåŠ¨ç”»æ˜¾ç¤ºï¼‰
  @State private appearedIds: string[] = []; // å·²å‡ºç°çš„å¡ç‰‡IDåˆ—è¡¨ï¼Œç”¨äºæŒ‰é¡¹æ·¡å…¥
  private staggerTimerId: number | undefined = undefined; // é€ä¸ªæ˜¾ç¤ºçš„å®šæ—¶å™¨ID
  private revealStartTs: number = 0; // å¡ç‰‡é€æ˜¾å¼€å§‹æ—¶é—´æˆ³
  @StorageLink('searchDistance') searchDistance: number = 500; // æœç´¢è·ç¦»ï¼Œé»˜è®¤500ç±³
  private geoService: HarmonyGeo | null = null;
  private mapService: MapService | null = null;
  private context: common.UIAbilityContext | null = null;

  async aboutToAppear() {
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      if (this.context) {
        this.geoService = new HarmonyGeo(this.context);
        this.mapService = await MapServiceFactory.createMapService();
      }
      
      // å¯åŠ¨å‘¼å¸åŠ¨ç”»
      this.startBreathingAnimation();
    } catch (err) {
      const error = err as BusinessError;
      console.error(TAG, `Failed to get context, error: ${JSON.stringify(error)}`);
      this.error = `Failed to get context: ${error.message}`;
    }
  }

  aboutToDisappear() {
    // ç»„ä»¶é€€å‡ºæ—¶å–æ¶ˆä»»ä½•æ®‹ç•™çš„é€æ˜¾å®šæ—¶å™¨ï¼Œé¿å…å¼‚æ­¥å›è°ƒå¯¼è‡´å´©æºƒ
    this.cancelStaggerReveal();
  }

  // å‘¼å¸åŠ¨ç”»
  private startBreathingAnimation() {
    const breathingLoop = () => {
      if (!this.buttonMoved) {
        animateTo({
          duration: 2000,
          curve: Curve.EaseInOut,
          iterations: -1,
          playMode: PlayMode.Alternate
        }, () => {
          this.breathingScale = 1.05;
        });
      }
    };
    breathingLoop();
  }

  // ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
  private handleButtonPress() {
    // ç‚¹å‡»ç¼©æ”¾åŠ¨ç”»
    this.buttonPressed = true;
    animateTo({
      duration: 100,
      curve: Curve.Sharp
    }, () => {
      this.buttonScale = 0.95;
    });
    
    // å¼¹è·³å›å¼¹åŠ¨ç”»
    setTimeout(() => {
      animateTo({
        duration: 200,
        curve: Curve.EaseOut
      }, () => {
        this.buttonScale = 1.1;
      });
      
      setTimeout(() => {
        animateTo({
          duration: 150,
          curve: Curve.EaseInOut
        }, () => {
          this.buttonScale = 1.0;
          this.buttonPressed = false;
        });
      }, 200);
    }, 100);
  }

  // è®¾ç½®æŒ‰é’®ç‚¹å‡»å¤„ç†
  private handleSettingsClick() {
    console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»');
    router.pushUrl({
      url: 'pages/Settings'
    }).catch((error: Error) => {
      console.error('å¯¼èˆªåˆ°è®¾ç½®é¡µé¢å¤±è´¥:', error.message);
    });
  }

  // æ»‘åŠ¨æ‰‹åŠ¿å¤„ç†æ–¹æ³•
  private handleSwipeStart(x: number) {
    this.swipeStartX = x;
    this.swipeCurrentX = x;
    this.isSwipeActive = true;
    this.swipeOffset = 0;
  }

  private handleSwipeMove(x: number) {
    if (!this.isSwipeActive) return;
    
    this.swipeCurrentX = x;
    this.swipeOffset = x - this.swipeStartX;
    
    // æ·»åŠ å®æ—¶è§†è§‰åé¦ˆ - è½»å¾®çš„åç§»æ•ˆæœ
    const maxOffset = 30; // æœ€å¤§åç§»é‡
    const normalizedOffset = Math.max(-maxOffset, Math.min(maxOffset, this.swipeOffset * 0.3));
    
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®æ—¶çš„è§†è§‰åé¦ˆï¼Œæ¯”å¦‚è½»å¾®çš„ä½ç§»æˆ–é€æ˜åº¦å˜åŒ–
  }

  private handleSwipeEnd() {
    if (!this.isSwipeActive) return;
    
    const swipeDistance = Math.abs(this.swipeOffset);
    const minSwipeDistance = 50; // æœ€å°æ»‘åŠ¨è·ç¦»
    
    if (swipeDistance > minSwipeDistance) {
      if (this.swipeOffset > 0) {
        // å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°æ­¥è¡Œ
        this.switchTravelMode('walking');
      } else {
        // å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°éª‘è¡Œ
        this.switchTravelMode('cycling');
      }
    }
    
    // é‡ç½®æ»‘åŠ¨çŠ¶æ€
    this.isSwipeActive = false;
    this.swipeOffset = 0;
    this.swipeStartX = 0;
    this.swipeCurrentX = 0;
  }

  private switchTravelMode(mode: string) {
    if (this.travelMode !== mode) {
      // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
      // HapticFeedback.impactLight();
      
      animateTo({
        duration: 400,
        curve: Curve.EaseInOut,
        playMode: PlayMode.Normal
      }, () => {
        this.travelMode = mode;
      });
      
      // æ·»åŠ åˆ‡æ¢æˆåŠŸçš„è§†è§‰æç¤º
      setTimeout(() => {
        animateTo({
          duration: 200,
          curve: Curve.EaseOut
        }, () => {
          // å¯ä»¥æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„é«˜äº®æ•ˆæœ
        });
      }, 100);
    }
  }

  // å¯¼èˆªåˆ°æŒ‡å®šå…¬å•ï¼ˆæ ¹æ®è®¾ç½®çš„åœ°å›¾Appï¼‰
  private async navigateToToilet(toilet: ToiletPoi) {
    if (!this.context) {
      console.error('å¯¼èˆªå¤±è´¥: ç¼ºå°‘UIä¸Šä¸‹æ–‡');
      return;
    }
    try {
      await MapLauncher.openNavigation(this.context, toilet, this.travelMode === 'walking' ? 'walking' : 'cycling');
    } catch (error) {
      console.error('å¯¼èˆªå¤±è´¥:', error);
      this.error = 'æœªèƒ½æ‰“å¼€ç›®æ ‡åœ°å›¾Appï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æˆ–é‡è¯•ã€‚';
    }
  }

  // ç”Ÿæˆæ˜¾å¼ç±»å‹çš„å¯¼èˆªå¤„ç†å™¨ï¼Œé¿å…åœ¨ UI å£°æ˜å—ä¸­ä¹¦å†™å¯¹è±¡å­—é¢é‡
  private makeNavigateHandler(toilet: ToiletPoi): NavigateHandler {
    return new NavigateHandlerImpl(() => {
      console.log(`å¯¼èˆªåˆ°å…¬å•: ${toilet.name}`);
      this.navigateToToilet(toilet);
    });
  }

  // å–æ¶ˆé€ä¸ªæ˜¾ç¤ºåŠ¨ç”»
  private cancelStaggerReveal() {
    if (this.staggerTimerId !== undefined) {
      clearTimeout(this.staggerTimerId);
      this.staggerTimerId = undefined;
    }
  }

  // è°ƒè¯•ï¼šå¡«å……ç©ºç™½å¡ç‰‡åˆ—è¡¨
  private debugShowBlankCards(count: number = 20) {
    // åœæ­¢ä»»ä½•è¿›è¡Œä¸­çš„é€æ˜¾é€»è¾‘
    this.cancelStaggerReveal();
    this.isLoading = false;
    // æ„é€ ç©ºç™½å¡ç‰‡æ•°æ®ï¼Œæ»¡è¶³ ToiletPoi æ¥å£ï¼ˆé¿å…ä½¿ç”¨æ³›å‹æ¨æ–­ä¸æœªç±»å‹åŒ–å¯¹è±¡ï¼‰
    const blanks: ToiletPoi[] = [];
    for (let i = 0; i < count; i++) {
      const item: ToiletPoi = {
        id: `debug-${i}`,
        name: '',
        address: '',
        location: { longitude: 0, latitude: 0 },
        distance: 0
      };
      blanks.push(item);
    }
    this.toilets = blanks;
    this.appearedIds = [];
    this.showToiletList = true;
    // ä¿è¯åˆ—è¡¨åŒºåŸŸå¯è§
    this.buttonMoved = true;
  }

  // å¯åŠ¨é€ä¸ªæ˜¾ç¤ºåŠ¨ç”»
  private async startStaggerReveal(total: number) {
    this.cancelStaggerReveal();
    this.visibleCount = 0;
    this.revealStartTs = Date.now();
    const target = Math.min(Math.max(total, 0), 200);
    // å†™å…¥â€œå¡ç‰‡æ˜¾ç¤ºå¼€å§‹â€æ—¥å¿—
    try {
      if (this.context) {
        await SearchLogStore.init(this.context);
        const top3 = this.toilets.slice(0, 3).map(t => `${t.name}(${t.distance}m)`).join(', ');
        const logStart: SearchLog = {
          timestamp: Date.now(),
          centerLatitude: this.center?.latitude,
          centerLongitude: this.center?.longitude,
          radiusMeters: this.searchDistance,
          resultCount: total,
          message: `å±•ç¤ºå¡ç‰‡å¼€å§‹ | æ¨¡å¼:${this.travelMode} | ç›®æ ‡:${target} | é—´éš”:80ms | Top3:${top3}`
        };
        await SearchLogStore.getInstance().append(logStart);
      }
    } catch (e) {
      console.warn('å†™å…¥å¡ç‰‡æ˜¾ç¤ºå¼€å§‹æ—¥å¿—å¤±è´¥:', e);
    }
    const step = async () => {
      if (this.visibleCount < target) {
        this.visibleCount++;
        this.staggerTimerId = setTimeout(step, 80);
      } else {
        this.cancelStaggerReveal();
        // å†™å…¥â€œå¡ç‰‡æ˜¾ç¤ºå®Œæˆâ€æ—¥å¿—
        try {
          if (this.context) {
            await SearchLogStore.init(this.context);
            const duration = Date.now() - this.revealStartTs;
            const top3 = this.toilets.slice(0, 3).map(t => `${t.name}(${t.distance}m)`).join(', ');
            const logDone: SearchLog = {
              timestamp: Date.now(),
              centerLatitude: this.center?.latitude,
              centerLongitude: this.center?.longitude,
              radiusMeters: this.searchDistance,
              resultCount: target,
              message: `å±•ç¤ºå¡ç‰‡å®Œæˆ | æ¨¡å¼:${this.travelMode} | ç”¨æ—¶:${duration}ms | å®é™…:${this.toilets.length} | Top3:${top3}`
            };
            await SearchLogStore.getInstance().append(logDone);
          }
        } catch (e) {
          console.warn('å†™å…¥å¡ç‰‡æ˜¾ç¤ºå®Œæˆæ—¥å¿—å¤±è´¥:', e);
        }
      }
    };
    step();
  }

  async handleFindToilet() {
    if (this.isLoading || !this.geoService || !this.mapService) {
      return;
    }
    
    // å…ˆæ‰§è¡Œç‚¹å‡»åŠ¨ç”»
    this.handleButtonPress();
    
    // å»¶è¿Ÿæ‰§è¡Œæœç´¢ï¼Œè®©åŠ¨ç”»å…ˆå®Œæˆ
    setTimeout(() => {
      // è§¦å‘æŒ‰é’®å‘ä¸‹ç§»åŠ¨åŠ¨ç”»
      this.buttonMoved = true;
      
      this.performSearch();
    }, 450); // ç­‰å¾…ç‚¹å‡»åŠ¨ç”»å®Œæˆ
  }

  private async performSearch() {
    this.isLoading = true;
    this.error = '';
    this.showToiletList = false;
    this.toilets = [];
    this.cancelStaggerReveal();
    this.visibleCount = 0;
    this.appearedIds = [];
    
    try {
      // æ£€æŸ¥æƒé™
      if (!await this.geoService!.checkPermission()) {
        try {
          await this.geoService!.requestPermission();
        } catch (permissionError) {
          this.error = 'Location permission denied. Please enable location access in settings.';
          this.isLoading = false;
          return;
        }
      }
      const location = await this.geoService!.getCurrentLocation();
      this.center = location;
      // å†™å…¥å®šä½æ—¥å¿—
      try {
        if (this.context) {
          await LocationLogStore.init(this.context);
          const locLog: LocationLog = {
            timestamp: Date.now(),
            latitude: location.latitude,
            longitude: location.longitude
          };
          await LocationLogStore.getInstance().append(locLog);
        }
      } catch (e) {
        console.warn('å†™å…¥å®šä½æ—¥å¿—å¤±è´¥:', e);
      }
      
      // æ·»åŠ ç§»åŠ¨åŠ¨ç”»çš„å»¶è¿Ÿæ•ˆæœ
      animateTo({
        duration: 600,
        curve: Curve.EaseInOut
      }, () => {
        // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æœç´¢è·ç¦»æœç´¢å…¬å•
        this.mapService!.searchNearbyToilets(location.longitude, location.latitude, this.searchDistance)
          .then(async (toilets: ToiletPoi[]) => {
            this.toilets = toilets;
            // é‡ç½®æ¯é¡¹å‡ºç°çŠ¶æ€ï¼Œé¿å…å¤ç”¨æ—§çš„åŠ¨ç”»æ ‡è®°
            this.appearedIds = [];
            this.showToiletList = true;
            // æ”¹ä¸ºæŒ‰é¡¹ onAppear æ·¡å…¥ï¼Œé¿å…é¢‘ç¹å…¨å±€çŠ¶æ€æ›´æ–°
            // å†™å…¥æœç´¢æˆåŠŸæ—¥å¿—
            try {
              if (this.context) {
                await SearchLogStore.init(this.context);
                const searchOk: SearchLog = {
                  timestamp: Date.now(),
                  centerLatitude: location.latitude,
                  centerLongitude: location.longitude,
                  radiusMeters: this.searchDistance,
                  resultCount: toilets.length
                };
                await SearchLogStore.getInstance().append(searchOk);
              }
            } catch (e) {
              console.warn('å†™å…¥æœç´¢æˆåŠŸæ—¥å¿—å¤±è´¥:', e);
            }
            // å†™å…¥å¡ç‰‡æ˜¾ç¤ºæ—¥å¿—
            try {
              if (this.context) {
                await SearchLogStore.init(this.context);
                const listLog: SearchLog = {
                  timestamp: Date.now(),
                  centerLatitude: location.latitude,
                  centerLongitude: location.longitude,
                  radiusMeters: this.searchDistance,
                  resultCount: toilets.length,
                  message: 'å±•ç¤ºå¡ç‰‡åˆ—è¡¨'
                };
                await SearchLogStore.getInstance().append(listLog);
              }
            } catch (e) {
              console.warn('å†™å…¥å¡ç‰‡æ˜¾ç¤ºæ—¥å¿—å¤±è´¥:', e);
            }
          })
          .catch(async (err: Error) => {
            const error = err as Error;
            console.error(TAG, `æœç´¢æ¥å£å¼‚å¸¸: ${error?.message}`);
            this.error = `æœç´¢å¤±è´¥ï¼š${error?.message || 'æœªçŸ¥é”™è¯¯'}`;
            this.showToiletList = false;
            // è®°å½•æœç´¢å¤±è´¥æ—¥å¿—
            try {
              if (this.context) {
                await SearchLogStore.init(this.context);
                const info1: SearchLogInfo = {
                  centerLatitude: location.latitude,
                  centerLongitude: location.longitude,
                  radiusMeters: this.searchDistance
                };
                await SearchLogStore.getInstance().appendError(
                  `æœç´¢å¤±è´¥: ${error?.message || 'Unknown error'}`,
                  info1
                );
              }
            } catch (e) {
              console.warn('å†™å…¥æœç´¢å¤±è´¥æ—¥å¿—å¤±è´¥:', e);
            }
          });
      });
      
    } catch (err) {
      const error = err as Error;
      console.error(TAG, `Failed to find toilets, error: ${JSON.stringify(error)}`);
      this.error = `Failed to find toilets: ${error.message || 'Unknown error'}`;
      // å†™å…¥æœç´¢å¤±è´¥æ—¥å¿—ï¼ˆä¸å®šä½æ—¥å¿—åˆ†å¼€ï¼‰
      try {
        if (this.context) {
          await SearchLogStore.init(this.context);
          const center = this.center;
          const info2: SearchLogInfo = {
            centerLatitude: center?.latitude,
            centerLongitude: center?.longitude,
            radiusMeters: this.searchDistance
          };
          await SearchLogStore.getInstance().appendError(
            `æœç´¢å¤±è´¥: ${error.message || 'Unknown error'}`,
            info2
          );
        }
      } catch (e) {
        console.warn('å†™å…¥æœç´¢å¤±è´¥æ—¥å¿—å¤±è´¥:', e);
      }
    } finally {
      this.isLoading = false;
    }
  }

  build(): void {
    Column() {
      // é¡¶éƒ¨è®¾ç½®æŒ‰é’®åŒºåŸŸ
      Row() {
        Button() {
          Text('â‹®')
            .fontSize(22)
            .fontColor($r('app.color.control_button_text'))
            .fontWeight(FontWeight.Medium)
        }
        .width(40)
        .height(40)
        .backgroundColor('transparent')
        .borderRadius(20)
        .onClick(() => this.handleSettingsClick())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12 })
      .justifyContent(FlexAlign.End)
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        if (!this.buttonMoved) {
          // å±…ä¸­æ˜¾ç¤ºçš„åœ†å½¢æ‰¾å±æŒ‰é’®
          Button('æ‰¾å±')
            .width(120)
            .height(120)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .backgroundColor($r('app.color.accent_color'))
            .borderRadius(60)
            .shadow({
              radius: 25,
              color: $r('app.color.accent_color'),
              offsetX: 0,
              offsetY: 10
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleSwipeStart(event.touches[0].x);
              } else if (event.type === TouchType.Move) {
                this.handleSwipeMove(event.touches[0].x);
              } else if (event.type === TouchType.Up) {
                this.handleSwipeEnd();
              }
            })
            .scale({
              x: this.buttonScale * this.breathingScale,
              y: this.buttonScale * this.breathingScale
            })
            .animation({
              duration: 500,
              curve: Curve.EaseInOut
            })
            .onClick(() => this.handleFindToilet())
        }
        
        // åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
        if (this.isLoading) {
          Column({ space: 16 }) {
            LoadingProgress()
              .width(40)
              .height(40)
              .color($r('app.color.accent_color'))

            Text('æ­£åœ¨æœç´¢é™„è¿‘çš„å…¬å•...')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
          }
          .margin({ top: 40 })
        }
        
        // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        if (this.error) {
          Column({ space: 12 }) {
            Text('ğŸ˜”')
              .fontSize(32)

            Text(this.error)
              .fontSize(14)
              .fontColor($r('app.color.error_text'))
              .textAlign(TextAlign.Center)
              .maxLines(2)
            
            Button('é‡è¯•')
              .width(80)
              .height(32)
              .fontSize(12)
              .backgroundColor($r('app.color.accent_color'))
              .borderRadius(16)
              .onClick(() => {
                this.error = '';
                this.handleFindToilet();
              })
          }
          .margin({ top: 40 })
          .padding(20)
        }
        
        // å…¬å•åˆ—è¡¨åŒºåŸŸ
        if (this.showToiletList && this.toilets.length > 0) {
          Column() {
            // åˆ—è¡¨å¤´éƒ¨ä¿¡æ¯
            Row() {
              Column({ space: 4 }) {
                Text(`æ‰¾åˆ° ${this.toilets.length} ä¸ªå…¬å•`)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))

                Text(`æœç´¢èŒƒå›´ ${this.searchDistance}ç±³`)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
              }
              .alignItems(HorizontalAlign.Start)
              
              Blank()
              
              // æ’åºæŒ‰é’®
              Button() {
                Row({ space: 4 }) {
                  Text('ğŸ“Š')
                    .fontSize(14)
                    .fontColor($r('app.color.control_button_text'))
                  Text('è·ç¦»æ’åº')
                    .fontSize(12)
                    .fontColor($r('app.color.control_button_text'))
                }
              }
              .width(80)
              .height(32)
              .backgroundColor('transparent')
              .borderRadius(16)
              .onClick(() => {
                // æŒ‰è·ç¦»é‡æ–°æ’åº
                this.toilets = this.toilets.sort((a, b) => a.distance - b.distance);
              })
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // å…¬å•å¡ç‰‡åˆ—è¡¨ï¼ˆä½¿ç”¨ List è™šæ‹ŸåŒ–ï¼Œå¹¶é€ä¸ªæ·¡å…¥å‡ºç°ï¼‰
            List({ space: 0 }) {
              ForEach(
                this.toilets,
                (toilet: ToiletPoi, index: number) => {
                  ListItem() {
                    // ä½¿ç”¨å†…å±‚å®¹å™¨åšåŠ¨ç”»ï¼Œé¿å…ç›´æ¥åœ¨ ListItem ä¸Šå˜æ¢
                    Column() {
                      ToiletCard({
                        toilet: toilet,
                        travelMode: this.travelMode,
                        onNavigate: this.makeNavigateHandler(toilet)
                      })
                    }
                    .opacity(this.appearedIds.indexOf(toilet.id) >= 0 ? 1 : 0)
                    .onAppear(() => {
                      // é¦–æ¬¡å‡ºç°æ—¶æ ‡è®°ä¸ºå·²å‡ºç°ï¼Œè§¦å‘æ·¡å…¥åŠ¨ç”»
                      if (this.appearedIds.indexOf(toilet.id) < 0) {
                        this.appearedIds = this.appearedIds.concat([toilet.id]);
                      }
                    })
                    .animation({
                      duration: 180,
                      curve: Curve.EaseOut
                    })
                  }
                },
                (toilet: ToiletPoi, index: number) => toilet.id || `${toilet.name}-${index}`
              )
            }
            .width('100%')
            .layoutWeight(1)
            .scrollBar(BarState.Auto)
            .edgeEffect(EdgeEffect.Spring)
            .divider({
              strokeWidth: 0,
              color: 'transparent'
            })
            .backgroundColor('transparent')
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 16 })
          .animation({
            duration: 400,
            curve: Curve.EaseOut
          })
        }
        
        // æ— ç»“æœæç¤º
        if (this.showToiletList && this.toilets.length === 0 && !this.isLoading) {
          Column({ space: 20 }) {
            // ç©ºçŠ¶æ€å›¾æ ‡
            Column({ space: 8 }) {
              Text('ğŸš½')
                .fontSize(64)
                .opacity(0.2)
              
              Text('ğŸ˜”')
                .fontSize(32)
                .opacity(0.4)
            }
            
            // æç¤ºæ–‡æœ¬
            Column({ space: 8 }) {
            Text('é™„è¿‘æ²¡æœ‰æ‰¾åˆ°å…¬å•')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))

            Text(`æœç´¢èŒƒå›´ï¼š${this.searchDistance}ç±³`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))

            Text('è¯•è¯•æ‰©å¤§æœç´¢èŒƒå›´æˆ–æ¢ä¸ªä½ç½®')
              .fontSize(14)
              .fontColor($r('app.color.text_tertiary'))
            }
            .alignItems(HorizontalAlign.Center)
            
            // æ“ä½œæŒ‰é’®
            Row({ space: 12 }) {
              Button('æ‰©å¤§èŒƒå›´')
                .width(100)
                .height(40)
                .fontSize(14)
                .backgroundColor($r('app.color.control_background'))
                .fontColor($r('app.color.accent_color'))
                .borderRadius(20)
                .border({
                  width: 1,
                  color: $r('app.color.accent_color')
                })
                .onClick(() => {
                  // æ‰©å¤§æœç´¢èŒƒå›´
                  if (this.searchDistance < 5000) {
                    this.searchDistance = Math.min(this.searchDistance * 2, 5000);
                    this.performSearch();
                  }
                })
              
              Button('é‡æ–°æœç´¢')
                .width(100)
                .height(40)
                .fontSize(14)
                .backgroundColor($r('app.color.accent_color'))
                .borderRadius(20)
                .onClick(() => {
                  this.showToiletList = false;
                  this.buttonMoved = false;
                })
            }
          }
          .width('100%')
          .padding(40)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .animation({
            duration: 400,
            curve: Curve.EaseOut
          })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(this.buttonMoved ? FlexAlign.Start : FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor($r('app.color.page_background'))
      
      // åº•éƒ¨å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨ï¼ˆæ·¡åŒ–è®¾è®¡ï¼‰
      if (this.buttonMoved) {
        // ç§»åŠ¨åçš„æŒ‰é’®æ˜¾ç¤ºåœ¨åº•éƒ¨é€‰æ‹©å™¨ä¸Šæ–¹
        Column({ space: 12 }) {
          Button('æ‰¾å±')
            .width(80)
            .height(80)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .backgroundColor($r('app.color.accent_color'))
            .borderRadius(40)
            .shadow({
              radius: 15,
              color: $r('app.color.accent_color'),
              offsetX: 0,
              offsetY: 5
            })
            .scale({
              x: this.buttonScale,
              y: this.buttonScale
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => this.handleFindToilet())
          
          // å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨
          Column({ space: 8 }) {
            Text('å‡ºè¡Œæ–¹å¼')
              .fontSize(12)
              .fontColor($r('app.color.text_tertiary'))

            Row({ space: 20 }) {
              // æ­¥è¡ŒæŒ‰é’®
              Column({ space: 4 }) {
                Text('ğŸš¶')
                  .fontSize(20)
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
                Text('æ­¥è¡Œ')
                  .fontSize(10)
                  .fontColor(this.travelMode === 'walking' ? $r('app.color.accent_color') : $r('app.color.text_disabled'))
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
              }
              .width(50)
              .height(50)
              .borderRadius(25)
              .backgroundColor(this.travelMode === 'walking' ? $r('app.color.accent_container') : 'transparent')
              .border({
                width: this.travelMode === 'walking' ? 2 : 1,
                color: this.travelMode === 'walking' ? $r('app.color.accent_color') : $r('app.color.control_button_border')
              })
              .justifyContent(FlexAlign.Center)
              .scale({
                x: this.travelMode === 'walking' ? 1.1 : 1.0,
                y: this.travelMode === 'walking' ? 1.1 : 1.0
              })
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
              .onClick(() => {
                this.travelMode = 'walking';
              })
              
              // éª‘è¡ŒæŒ‰é’®
              Column({ space: 4 }) {
                Text('ğŸš´')
                  .fontSize(20)
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
                Text('éª‘è¡Œ')
                  .fontSize(10)
                  .fontColor(this.travelMode === 'cycling' ? $r('app.color.accent_color') : $r('app.color.text_disabled'))
                  .animation({
                    duration: 200,
                    curve: Curve.EaseOut
                  })
              }
              .width(50)
              .height(50)
              .borderRadius(25)
              .backgroundColor(this.travelMode === 'cycling' ? $r('app.color.accent_container') : 'transparent')
              .border({
                width: this.travelMode === 'cycling' ? 2 : 1,
                color: this.travelMode === 'cycling' ? $r('app.color.accent_color') : $r('app.color.control_button_border')
              })
              .justifyContent(FlexAlign.Center)
              .scale({
                x: this.travelMode === 'cycling' ? 1.1 : 1.0,
                y: this.travelMode === 'cycling' ? 1.1 : 1.0
              })
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
              .onClick(() => {
                this.travelMode = 'cycling';
              })
            }
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleSwipeStart(event.touches[0].x);
              } else if (event.type === TouchType.Move) {
                this.handleSwipeMove(event.touches[0].x);
              } else if (event.type === TouchType.Up) {
                this.handleSwipeEnd();
              }
            })
          }
          .onTouch((event: TouchEvent) => {
            if (event.type === TouchType.Down) {
              this.handleSwipeStart(event.touches[0].x);
            } else if (event.type === TouchType.Move) {
              this.handleSwipeMove(event.touches[0].x);
            } else if (event.type === TouchType.Up) {
              this.handleSwipeEnd();
            }
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 20 })
        .backgroundColor('transparent')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // åŸå§‹åº•éƒ¨å‡ºè¡Œæ–¹å¼é€‰æ‹©å™¨
        Column({ space: 8 }) {
          Text('å‡ºè¡Œæ–¹å¼')
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))

          Row({ space: 20 }) {
            // æ­¥è¡ŒæŒ‰é’®
            Column({ space: 4 }) {
              Text('ğŸš¶')
                .fontSize(20)
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
              Text('æ­¥è¡Œ')
                .fontSize(10)
                .fontColor(this.travelMode === 'walking' ? $r('app.color.accent_color') : $r('app.color.text_disabled'))
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
            }
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor(this.travelMode === 'walking' ? $r('app.color.accent_container') : 'transparent')
            .border({
              width: this.travelMode === 'walking' ? 2 : 1,
              color: this.travelMode === 'walking' ? $r('app.color.accent_color') : $r('app.color.control_button_border')
            })
            .justifyContent(FlexAlign.Center)
            .scale({
              x: this.travelMode === 'walking' ? 1.1 : 1.0,
              y: this.travelMode === 'walking' ? 1.1 : 1.0
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => {
              this.travelMode = 'walking';
            })
            
            // éª‘è¡ŒæŒ‰é’®
            Column({ space: 4 }) {
              Text('ğŸš´')
                .fontSize(20)
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
              Text('éª‘è¡Œ')
                .fontSize(10)
                .fontColor(this.travelMode === 'cycling' ? $r('app.color.accent_color') : $r('app.color.text_disabled'))
                .animation({
                  duration: 200,
                  curve: Curve.EaseOut
                })
            }
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor(this.travelMode === 'cycling' ? $r('app.color.accent_container') : 'transparent')
            .border({
              width: this.travelMode === 'cycling' ? 2 : 1,
              color: this.travelMode === 'cycling' ? $r('app.color.accent_color') : $r('app.color.control_button_border')
            })
            .justifyContent(FlexAlign.Center)
            .scale({
              x: this.travelMode === 'cycling' ? 1.1 : 1.0,
              y: this.travelMode === 'cycling' ? 1.1 : 1.0
            })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
            .onClick(() => {
              this.travelMode = 'cycling';
            })
          }
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 20 })
        .backgroundColor('transparent')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('white')
  }
}



