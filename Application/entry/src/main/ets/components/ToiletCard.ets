/**
 * å•æ‰€å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºå•ä¸ªå•æ‰€çš„è¯¦ç»†ä¿¡æ¯
 */

import { ToiletPoi } from '../map/MapService';

// é€šè¿‡å¯¹è±¡å›è°ƒä¼ é€’å¯¼èˆªåŠ¨ä½œï¼Œé¿å…ç›´æ¥ä¼ å‡½æ•°å¯¼è‡´çš„ç¼–è¯‘/è¿è¡Œé™åˆ¶
export interface NavigateHandler {
  run(): void;
}

// ä¸º ArkTS V1 æ˜¾å¼æä¾›ä¸€ä¸ªç±»å®ç°ï¼Œæ–¹ä¾¿åœ¨è°ƒç”¨æ–¹é¿å…å¯¹è±¡å­—é¢é‡
export class NavigateHandlerImpl implements NavigateHandler {
  private fn: () => void;
  constructor(fn: () => void) {
    this.fn = fn;
  }
  run(): void {
    this.fn();
  }
}

@Component
export struct ToiletCard {
  @Prop toilet: ToiletPoi;
  @Prop travelMode: string;
  @Prop onNavigate: NavigateHandler | null = null;

  // æ ¹æ®è·ç¦»è·å–é¢œè‰²
  private getDistanceColor(): string {
    if (this.toilet.distance <= 200) return '#00C851'; // ç»¿è‰² - å¾ˆè¿‘
    if (this.toilet.distance <= 500) return '#FF8800'; // æ©™è‰² - ä¸­ç­‰
    return '#FF4444'; // çº¢è‰² - è¾ƒè¿œ
  }

  // æ ¹æ®è·ç¦»è·å–æ­¥è¡Œæ—¶é—´ä¼°ç®—
  private getWalkingTime(): string {
    const walkingSpeed = 80; // ç±³/åˆ†é’Ÿ
    const cyclingSpeed = 200; // ç±³/åˆ†é’Ÿ
    
    const speed = this.travelMode === 'walking' ? walkingSpeed : cyclingSpeed;
    const minutes = Math.ceil(this.toilet.distance / speed);
    
    return `çº¦${minutes}åˆ†é’Ÿ`;
  }

  // è·å–è·ç¦»æ˜¾ç¤ºæ–‡æœ¬
  private getDistanceText(): string {
    if (this.toilet.distance < 1000) {
      return `${this.toilet.distance}m`;
    } else {
      return `${(this.toilet.distance / 1000).toFixed(1)}km`;
    }
  }

  build() {
    Row() {
      // å·¦ä¾§å›¾æ ‡å’Œè·ç¦»æŒ‡ç¤ºå™¨
      Column({ space: 4 }) {
        Text('ğŸš½')
          .fontSize(28)
        
        // è·ç¦»åœ†ç‚¹æŒ‡ç¤ºå™¨
        Circle({ width: 8, height: 8 })
          .fill(this.getDistanceColor())
      }
      .width(60)
      .height(70)
      .backgroundColor('#F8F9FA')
      .borderRadius(12)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      
      // ä¸­é—´ä¿¡æ¯åŒºåŸŸ
      Column({ space: 6 }) {
        // å…¬å•åç§°
        Text(this.toilet.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        // åœ°å€ä¿¡æ¯ï¼ˆå…œåº•ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé¿å…æœªå®šä¹‰å¯¼è‡´å¼‚å¸¸ï¼‰
        Text(this.toilet.address || '')
          .fontSize(13)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(18)
        
        // è·ç¦»å’Œæ—¶é—´ä¿¡æ¯
        Row({ space: 12 }) {
          // è·ç¦»æ ‡ç­¾
          Row({ space: 4 }) {
            Text('ğŸ“')
              .fontSize(12)
            Text(this.getDistanceText())
              .fontSize(13)
              .fontColor(this.getDistanceColor())
              .fontWeight(FontWeight.Medium)
          }
          
          // æ—¶é—´ä¼°ç®—
          Row({ space: 4 }) {
            Text(this.travelMode === 'walking' ? 'ğŸš¶' : 'ğŸš´')
              .fontSize(12)
            Text(this.getWalkingTime())
              .fontSize(13)
              .fontColor('#007DFF')
          }
        }
        .alignItems(VerticalAlign.Center)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 16, right: 12 })
      .justifyContent(FlexAlign.SpaceBetween)

      // å³ä¾§å¯¼èˆªæŒ‰é’®
      Column({ space: 8 }) {
        Button() {
          Row({ space: 4 }) {
            Text('ğŸ§­')
              .fontSize(14)
            Text('å¯¼èˆª')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
          }
        }
        .width(70)
        .height(36)
        .backgroundColor('#007DFF')
        .borderRadius(18)
        .onClick(() => {
          // è§¦å‘çˆ¶ç»„ä»¶çš„å¯¼èˆªäº‹ä»¶ï¼ˆé˜²æ­¢æœªä¼ å…¥æ—¶å¼‚å¸¸ï¼‰
          if (this.onNavigate) {
            this.onNavigate.run();
          }
        })
      }
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height(90)
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#00000008',
      offsetX: 0,
      offsetY: 4
    })
    .border({
      width: 1,
      color: '#F0F0F0'
    })
    .margin({ bottom: 12 })
    .animation({
      duration: 200,
      curve: Curve.EaseOut
    })
  }
}

