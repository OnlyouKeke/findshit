/**
 * å•æ‰€å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºé™„è¿‘å•æ‰€åˆ—è¡¨å’Œä¸€é”®æ‰¾å•æ‰€æŒ‰é’®
 * é›†æˆæ—¶é—´è°ƒèŠ‚å™¨å’Œå‡ºè¡Œæ–¹å¼é€‰æ‹©
 */

import { Callback0, Callback1, TravelMode } from '../common/types';
import { NavigationControls } from './NavigationControls';

@Component
export struct ToiletCard {
  // åŠ è½½çŠ¶æ€
  @Prop loading: boolean = false;

  // äº¤äº’å›è°ƒï¼ˆä½¿ç”¨å¯¹è±¡åŒ…è£…ï¼Œå…¼å®¹ ArkUI V1ï¼‰
  @Prop onFindToiletClick: Callback0 = { handler: undefined };
  @Prop onTimeChange: Callback1<number> = { handler: undefined };
  @Prop onModeChange: Callback1<TravelMode> = { handler: undefined };

  // å†…éƒ¨çŠ¶æ€
  @State selectedTime: number = 2;
  @State travelMode: TravelMode = TravelMode.WALKING;

  build() {
    Column({ space: 16 }) {
      // å¯¼èˆªæ§åˆ¶åŒºåŸŸ
      Row() {
        // å·¦ä¾§ï¼šæ—¶é—´è°ƒèŠ‚å™¨
        this.buildTimeSelector()
        
        // ä¸­é—´ï¼šæ‰¾å•æ‰€æŒ‰é’®
        Button(this.loading ? 'å®šä½ä¸­...' : 'æ‰¾å•æ‰€')
          .width(100)
          .height(100)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .backgroundColor(this.loading ? '#CCCCCC' : '#4C8BF5')
          .borderRadius(50)
          .enabled(!this.loading)
          .onClick(() => {
            this.onFindToiletClick.handler?.();
          })
        
        // å³ä¾§ï¼šå‡ºè¡Œæ–¹å¼å¼€å…³
        this.buildModeSwitch()
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .height(200)
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
    .shadow({ radius: 8, color: '#1F000000', offsetX: 0, offsetY: -2 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding({ left: 20, right: 20, top: 16, bottom: 0 })
  }

  @Builder
  buildTimeSelector() {
    Column({ space: 8 }) {
      // å›ºå®šæ ‡é¢˜
      Text('åˆ†é’Ÿ')
        .fontSize(12)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
      
      // æ»‘åŠ¨æ»šè½®é€‰æ‹©å™¨
      Column() {
        TextPicker({ range: ['2', '5', '10'], selected: this.getSelectedIndex() })
          .width(60)
          .height(120)
          .backgroundColor('#F8F9FA')
          .borderRadius(8)
          .canLoop(false)
          .onChange((value: string | string[], index: number | number[]) => {
            const selectedValue = Array.isArray(value) ? value[0] : value;
            const timeValue = parseInt(selectedValue);
            this.selectedTime = timeValue;
            this.onTimeChange.handler?.(timeValue);
          })
      }
    }
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildModeSwitch() {
    Column({ space: 8 }) {
      // Toggleå¼€å…³ç»„ä»¶
      Toggle({ type: ToggleType.Switch, isOn: this.travelMode === TravelMode.CYCLING })
        .selectedColor('#4C8BF5')
        .switchPointColor('#FFFFFF')
        .onChange((isOn: boolean) => {
          this.travelMode = isOn ? TravelMode.CYCLING : TravelMode.WALKING;
          this.onModeChange.handler?.(this.travelMode);
        })
      
      // æ¨¡å¼æ ‡ç­¾
      Row({ space: 12 }) {
        // æ­¥è¡Œå›¾æ ‡å’Œæ–‡å­—
        Column({ space: 1 }) {
          Text('ğŸš¶')
            .fontSize(12)
          Text('æ­¥è¡Œ')
            .fontSize(8)
            .fontColor(this.travelMode === TravelMode.WALKING ? '#4C8BF5' : '#999999')
        }
        .opacity(this.travelMode === TravelMode.WALKING ? 1 : 0.6)
        
        // éª‘è¡Œå›¾æ ‡å’Œæ–‡å­—
        Column({ space: 1 }) {
          Text('ğŸš´')
            .fontSize(12)
          Text('éª‘è¡Œ')
            .fontSize(8)
            .fontColor(this.travelMode === TravelMode.CYCLING ? '#4C8BF5' : '#999999')
        }
        .opacity(this.travelMode === TravelMode.CYCLING ? 1 : 0.6)
      }
    }
    .alignItems(HorizontalAlign.Center)
  }

  // è·å–å½“å‰é€‰ä¸­æ—¶é—´çš„ç´¢å¼•
  private getSelectedIndex(): number {
    const timeOptions = [2, 5, 10];
    const index = timeOptions.indexOf(this.selectedTime);
    return index >= 0 ? index : 0; // é»˜è®¤é€‰ä¸­2åˆ†é’Ÿï¼ˆç´¢å¼•0ï¼‰
  }
}

